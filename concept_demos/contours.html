<!DOCTYPE html>
<html>
  <head>
    <title>Snail Eyes - Proof of Concept</title>
    <script>
      const w = 640;
      const h = 480;
      function setup() {
        cam = document.getElementById("cam");
        fine = document.getElementById("fine");
        draw = document.getElementById("canvas1").getContext('2d');
        draw1 = document.getElementById("canvas2").getContext('2d');
        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
          navigator.mediaDevices.getUserMedia({video:{
            width: { ideal: w },
            height: { ideal: h }
          }}).then(function(stream) {
            cam.srcObject = stream;
            cam.play();
          });
        }
        setInterval(snap, 70);
      }
      function snap() {
        draw.drawImage(cam,0,0,w,h);
        pixels = draw.getImageData(0,0,w,h);
        f = parseInt(fine.value);
        var px, pxr, pxd;
        for (x=0; x<w; x+=f) {
          for (y=0; y<h; y+=f) {
            px = pxl(x,y);
            pxr = pxl(x+f,y);
            pxd = pxl(x,y+f);
            if (Math.max(Math.abs(greyscale(px)-greyscale(pxr)),Math.abs(greyscale(px)-greyscale(pxd))) > 12) {
              draw1.fillStyle = "#000000";
            } else {
              draw1.fillStyle = "#ffffff";
            }
            draw1.fillRect(x,y,f,f);
          }
        }
      }
      function pxl(X,Y) { // Returns colour of pixel in JSON
        return {
          r : pixels.data[4*w*Y+4*X],
          g : pixels.data[4*w*Y+4*X+1],
          b : pixels.data[4*w*Y+4*X+2]
        };
      }
      function greyscale(col) {
        return 0.299*col.r+0.587*col.g+0.114*col.b;
      }
    </script>
    <style>
      .hide {
        display: none
      }
    </style>
  </head>
  <body onload="setup()">
    <video id="cam" class="hide" width="640" height="480" autoplay></video>
    <br>
    <label for="fine">Processing Square Size:</label>
    <input type="number" id="fine" min="1" max="100" value="3">
    <br>
    <canvas id="canvas1" width="640" height="480"></canvas>
    <canvas id="canvas2" width="640" height="480"></canvas>
  </body>
</html>